name: Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        pyscf-version: ["2.9", "2.11"]
        exclude: # Skip PySCF 2.11 on Python 3.12 because of multithreading crash when calling getints2c
          - python-version: "3.12" 
            pyscf-version: "2.11"

    name: "Python=${{ matrix.python-version }} & PySCF=${{ matrix.pyscf-version }}"
    steps:
    - uses: actions/checkout@v4

    - name: Setup micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-file: environment-cpu.yml
        environment-name: skala
        cache-environment: true
        cache-downloads: true
        create-args: >-
          python=${{ matrix.python-version }}
          pyscf=${{ matrix.pyscf-version }}

    - name: Install package in development mode
      run: |
        pip install -e . --no-deps
      shell: micromamba-shell {0}

    - name: Check environment consistency
      run: |
        pip check
      shell: micromamba-shell {0}

    - name: Run pre-commit hooks
      run: |
        pre-commit install
        pre-commit run --all-files
      shell: micromamba-shell {0}

    - name: Run tests with coverage
      run: >-
        pytest
        -v
        --doctest-modules
        --cov=skala --cov-report=xml --cov-report=term-missing --cov-report=html
        --durations=50 --durations-min=1.0
        --pyargs skala
        tests/
      shell: micromamba-shell {0}
